<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Insumos de Galpón con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Librería para leer archivos CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .prose { max-width: 100%; }
        .prose strong { font-weight: 600; color: #111827; }
        .prose p { margin-bottom: 1rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 1rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.5rem; }
        .code-block {
            background-color: #f3f4f6; border-radius: 0.5rem; padding: 1rem;
            font-family: monospace; white-space: pre-wrap; word-wrap: break-word;
            font-size: 0.875rem; margin-top: 1rem;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        /* Estilos para validación */
        .validation-message {
            font-size: 0.875rem;
            color: #ef4444; /* red-500 */
            min-height: 1.25rem;
        }
        .input-error {
            border-color: #ef4444 !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Control de Insumos de Galpón</h1>
            <p class="text-gray-600 mt-2">Gestiona tu stock de forma organizada e inteligente.</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-tab="control-stock">Control de Stock</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-tab="ingreso-insumos">Ingreso de Insumos</button>
            </nav>
        </div>

        <div id="tab-content-container">
            <div id="control-stock" class="tab-content">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                     <div class="relative w-full md:w-1/3">
                        <input type="text" id="search-input" placeholder="Buscar por nombre o código..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="descargar-excel-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-300 flex items-center gap-2">Excel</button>
                        <button id="analizar-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-300 flex items-center gap-2">✨ Analizar</button>
                    </div>
                </div>
                <div id="loading-state" class="text-center py-8"><p class="text-gray-500">Cargando inventario...</p></div>
                <div id="container-principal">
                    <div id="empty-state" class="hidden text-center bg-white p-8 rounded-lg shadow-md">
                         <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">Inventario vacío</h3>
                        <p class="mt-1 text-sm text-gray-500">Ve a la solapa "Ingreso de Insumos" para empezar.</p>
                        <div class="mt-6">
                            <button id="cargar-datos-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700">Cargar Lista de Insumos Inicial</button>
                        </div>
                    </div>
                    <div id="lista-insumos" class="space-y-3"></div>
                </div>
            </div>

            <div id="ingreso-insumos" class="tab-content">
                 <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Agregar Nuevo Insumo Manualmente</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                        <div>
                            <input type="text" id="nombre-insumo" placeholder="Nombre del insumo" class="p-3 w-full border border-gray-300 rounded-lg">
                            <p id="nombre-insumo-validation" class="validation-message"></p>
                        </div>
                        <div>
                            <input type="text" id="codigo-insumo" placeholder="Código (Opcional)" class="p-3 w-full border border-gray-300 rounded-lg">
                            <p id="codigo-insumo-validation" class="validation-message"></p>
                        </div>
                        <div>
                            <input type="number" id="cantidad-inicial" placeholder="Cantidad" min="0" class="p-3 w-full border border-gray-300 rounded-lg">
                            <p id="cantidad-inicial-validation" class="validation-message"></p>
                        </div>
                        <div>
                            <input type="text" id="unidad-insumo" placeholder="Unidad (ej: Lt, Kg)" class="p-3 w-full border border-gray-300 rounded-lg">
                            <p id="unidad-insumo-validation" class="validation-message"></p>
                        </div>
                        <div class="md:col-span-2">
                            <button id="agregar-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed">Agregar al Inventario</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4">Importar desde Archivo CSV</h2>
                    <p class="text-gray-600 mb-4">Sube un archivo `.csv` con las columnas: <code class="bg-gray-200 p-1 rounded">Código,Producto,Cantidad,Unidad</code>. La primera fila debe ser el encabezado.</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    <button id="import-csv-btn" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center">Importar Archivo</button>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-12 text-sm text-gray-500"><p>ID de Sesión: <span id="user-id-display" class="font-mono bg-gray-200 p-1 rounded"></span></p></footer>
    </div>

    <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop"></div>
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full z-10 modal-content transform scale-95">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="modal-body" class="text-gray-700"></div>
            <div id="modal-actions" class="mt-6 flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="modal-save-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Cambios</button>
                <button id="modal-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Confirmar</button>
                <button id="modal-ok-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, increment, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsjMYndgto8apKjasCtD7Hsblw5f6DV8c",
            authDomain: "stock-pomco.firebaseapp.com",
            projectId: "stock-pomco",
            storageBucket: "stock-pomco.firebasestorage.app",
            messagingSenderId: "414907870481",
            appId: "1:414907870481:web:04d62d1dc974cc466cb0b0",
            measurementId: "G-G7QXY50X7B"
        };

        let app, db, auth, userId, inventarioActual = [], modalResolve, isEditing = false;

        // FIX: Se agregaron las referencias a los elementos de validación.
        const refs = {
            nombreInsumo: document.getElementById('nombre-insumo'), codigoInsumo: document.getElementById('codigo-insumo'),
            cantidadInicial: document.getElementById('cantidad-inicial'), unidadInsumo: document.getElementById('unidad-insumo'),
            nombreInsumoValidation: document.getElementById('nombre-insumo-validation'), 
            cantidadInicialValidation: document.getElementById('cantidad-inicial-validation'),
            unidadInsumoValidation: document.getElementById('unidad-insumo-validation'),
            agregarBtn: document.getElementById('agregar-btn'), containerPrincipal: document.getElementById('container-principal'),
            listaInsumos: document.getElementById('lista-insumos'), loadingState: document.getElementById('loading-state'),
            emptyState: document.getElementById('empty-state'), cargarDatosBtn: document.getElementById('cargar-datos-btn'),
            userIdDisplay: document.getElementById('user-id-display'), analizarBtn: document.getElementById('analizar-btn'),
            descargarExcelBtn: document.getElementById('descargar-excel-btn'), searchInput: document.getElementById('search-input'),
            tabs: document.querySelectorAll('.tab-btn'), tabContents: document.querySelectorAll('.tab-content'),
            csvFileInput: document.getElementById('csv-file-input'), importCsvBtn: document.getElementById('import-csv-btn'),
            modal: {
                el: document.getElementById('modal'), backdrop: document.getElementById('modal-backdrop'),
                content: document.getElementById('modal-content'), title: document.getElementById('modal-title'),
                body: document.getElementById('modal-body'), cancelBtn: document.getElementById('modal-cancel-btn'),
                saveBtn: document.getElementById('modal-save-btn'), confirmBtn: document.getElementById('modal-confirm-btn'),
                okBtn: document.getElementById('modal-ok-btn'),
            }
        };

        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await enableIndexedDbPersistence(db).catch((err) => {
                    if (err.code == 'failed-precondition') console.warn("Persistencia offline no habilitada, múltiples solapas abiertas?");
                    else if (err.code == 'unimplemented') console.warn("El navegador no soporta persistencia offline.");
                });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        refs.userIdDisplay.textContent = userId;
                        configurarEventListeners();
                        escucharCambiosEnInsumos();
                        activarTab('control-stock');
                    } else await signInAnonymously(auth);
                });
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                refs.loadingState.classList.add('hidden');
                refs.containerPrincipal.innerHTML = `<p class="text-red-500 text-center">Error al conectar. Revisa la consola.</p>`;
            }
        }

        function activarTab(tabId) {
            refs.tabContents.forEach(c => c.classList.remove('active'));
            refs.tabs.forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        function showModal(title, body, type = 'alert') {
            refs.modal.title.textContent = title;
            refs.modal.body.innerHTML = body;
            refs.modal.okBtn.style.display = type === 'alert' ? 'inline-block' : 'none';
            refs.modal.confirmBtn.style.display = type === 'confirm' ? 'inline-block' : 'none';
            refs.modal.saveBtn.style.display = type === 'edit' ? 'inline-block' : 'none';
            refs.modal.cancelBtn.style.display = (type === 'confirm' || type === 'edit') ? 'inline-block' : 'none';
            refs.modal.el.classList.remove('hidden');
            refs.modal.el.classList.add('flex');
            return new Promise(resolve => { modalResolve = resolve; });
        }

        function hideModal(value) {
            refs.modal.el.classList.add('hidden');
            refs.modal.el.classList.remove('flex');
            if (modalResolve) modalResolve(value);
        }

        function manejarErrorDePermisos(error) {
            console.error("Error de permisos:", error);
            showModal("Error de Permisos", `<p class="mb-3">La app no tiene permiso para acceder a la base de datos. Esto se debe a que las <strong>Reglas de Seguridad</strong> de tu proyecto en Firebase no están configuradas correctamente.</p><p class="mb-2">Por favor, ve a <strong>Firestore Database > Reglas</strong> en tu Consola de Firebase y usa estas reglas:</p><div class="code-block">rules_version = '2';<br>service cloud.firestore {<br>&nbsp;&nbsp;match /databases/{database}/documents {<br>&nbsp;&nbsp;&nbsp;&nbsp;match /insumos/{userId}/{document=**} {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if request.auth != null && request.auth.uid == userId;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>}</div>`);
        }
        
        function validarFormularioIngreso() {
            let esValido = true;
            
            if (refs.nombreInsumo.value.trim() === '') {
                refs.nombreInsumoValidation.textContent = 'El nombre es obligatorio.';
                refs.nombreInsumo.classList.add('input-error');
                esValido = false;
            } else {
                refs.nombreInsumoValidation.textContent = '';
                refs.nombreInsumo.classList.remove('input-error');
            }

            const cantidad = parseFloat(refs.cantidadInicial.value);
            if (refs.cantidadInicial.value.trim() === '' || isNaN(cantidad) || cantidad < 0) {
                 refs.cantidadInicialValidation.textContent = 'Debe ser un número válido y positivo.';
                 refs.cantidadInicial.classList.add('input-error');
                 esValido = false;
            } else {
                refs.cantidadInicialValidation.textContent = '';
                refs.cantidadInicial.classList.remove('input-error');
            }

            if (refs.unidadInsumo.value.trim() === '') {
                refs.unidadInsumoValidation.textContent = 'La unidad es obligatoria.';
                refs.unidadInsumo.classList.add('input-error');
                esValido = false;
            } else {
                refs.unidadInsumoValidation.textContent = '';
                refs.unidadInsumo.classList.remove('input-error');
            }

            refs.agregarBtn.disabled = !esValido;
            return esValido;
        }

        function configurarEventListeners() {
            refs.tabs.forEach(tab => tab.addEventListener('click', () => activarTab(tab.dataset.tab)));
            refs.agregarBtn.addEventListener('click', agregarInsumo);
            refs.analizarBtn.addEventListener('click', analizarInventarioConGemini);
            refs.cargarDatosBtn.addEventListener('click', cargarDatosIniciales);
            refs.descargarExcelBtn.addEventListener('click', descargarExcel);
            refs.importCsvBtn.addEventListener('click', handleCsvImport);
            refs.searchInput.addEventListener('input', () => renderizarListaInsumos(inventarioActual));
            refs.listaInsumos.addEventListener('click', handleListaInsumosClick);

            [refs.nombreInsumo, refs.cantidadInicial, refs.unidadInsumo].forEach(input => {
                input.addEventListener('input', validarFormularioIngreso);
            });
            
            // FIX: Llamar a la validación al inicio para establecer el estado inicial del botón
            validarFormularioIngreso();

            refs.modal.backdrop.addEventListener('click', () => hideModal(false));
            refs.modal.cancelBtn.addEventListener('click', () => hideModal(false));
            refs.modal.confirmBtn.addEventListener('click', () => hideModal(true));
            refs.modal.okBtn.addEventListener('click', () => hideModal(true));
        }
        
        async function handleListaInsumosClick(e) {
            const button = e.target.closest('button');
            const span = e.target.closest('span[data-action="edit-quantity"]');

            if (button) {
                const insumoId = button.dataset.id;
                if (!insumoId) return;
                const action = button.dataset.action;
                const docRef = doc(db, "insumos", userId, "items", insumoId);
                try {
                    if (action === 'restar') await updateDoc(docRef, { cantidad: increment(-1) });
                    else if (action === 'sumar') await updateDoc(docRef, { cantidad: increment(1) });
                    else if (action === 'eliminar') {
                        if (await showModal('Confirmar Eliminación', '¿Estás seguro?', 'confirm')) await deleteDoc(docRef);
                    } else if (action === 'editar') {
                        const insumo = inventarioActual.find(item => item.id === insumoId);
                        if (insumo) mostrarModalEdicion(insumo);
                    }
                } catch (error) {
                    if (error.code === 'permission-denied') manejarErrorDePermisos(error);
                    else { console.error("Error:", error); showModal("Error", "No se pudo realizar la operación."); }
                }
            } else if (span && !isEditing) {
                isEditing = true;
                const insumoId = span.dataset.id;
                const insumo = inventarioActual.find(item => item.id === insumoId);
                if (insumo) editarCantidadDirectamente(span, insumo);
            }
        }
        
        function editarCantidadDirectamente(spanElement, insumo) {
            const originalContent = spanElement.innerHTML;
            spanElement.innerHTML = `
                <div class="flex items-center gap-1">
                    <input type="number" value="${insumo.cantidad}" class="w-24 text-center bg-white border border-indigo-300 rounded-md p-2"/>
                    <button data-action="save-qty" class="p-2 text-green-600 rounded-md hover:bg-green-100"><svg class="h-6 w-6 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                    <button data-action="cancel-qty" class="p-2 text-red-600 rounded-md hover:bg-red-100"><svg class="h-6 w-6 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.697a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                </div>`;

            const input = spanElement.querySelector('input');
            const [saveBtn, cancelBtn] = spanElement.querySelectorAll('button');
            input.focus();
            input.select();

            const finalizeEdit = () => { isEditing = false; };

            const saveChanges = async () => {
                const nuevaCantidad = parseFloat(input.value);
                if (!isNaN(nuevaCantidad) && nuevaCantidad >= 0) {
                    try {
                        await updateDoc(doc(db, "insumos", userId, "items", insumo.id), { cantidad: nuevaCantidad });
                    } catch (error) {
                        if (error.code === 'permission-denied') manejarErrorDePermisos(error);
                        else { console.error("Error al actualizar:", error); showModal("Error", "No se pudo actualizar."); }
                    }
                }
                finalizeEdit();
            };
            
            const cancelChanges = () => {
                finalizeEdit();
                renderizarListaInsumos(inventarioActual);
            };

            saveBtn.onclick = saveChanges;
            cancelBtn.onclick = cancelChanges;
            input.onkeydown = (e) => { if (e.key === 'Enter') saveChanges(); if (e.key === 'Escape') cancelChanges(); };
            input.onblur = (e) => { if (!spanElement.contains(e.relatedTarget)) cancelChanges(); };
        }

        async function agregarInsumo() {
            if (!validarFormularioIngreso()) return;
            if (!userId) return showModal('Error', 'No se ha podido identificar al usuario.');
            
            const nombre = refs.nombreInsumo.value.trim();
            const codigo = refs.codigoInsumo.value.trim();
            const cantidad = parseFloat(refs.cantidadInicial.value);
            const unidad = refs.unidadInsumo.value.trim();
            
            try {
                await addDoc(collection(db, "insumos", userId, "items"), { nombre, codigo: codigo || '', cantidad, unidad, createdAt: new Date() });
                [refs.nombreInsumo, refs.codigoInsumo, refs.cantidadInicial, refs.unidadInsumo].forEach(i => i.value = '');
                validarFormularioIngreso();
                showModal('Éxito', 'Insumo agregado correctamente.');
                activarTab('control-stock');
            } catch (error) {
                if (error.code === 'permission-denied') manejarErrorDePermisos(error);
                else { console.error("Error al agregar:", error); showModal('Error', 'Hubo un error al guardar.'); }
            }
        }

        function escucharCambiosEnInsumos() {
            if (!userId) return;
            const q = query(collection(db, "insumos", userId, "items"));
            onSnapshot(q, (snapshot) => {
                refs.loadingState.classList.add('hidden');
                refs.containerPrincipal.classList.remove('hidden');
                inventarioActual = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!isEditing) {
                    renderizarListaInsumos(inventarioActual);
                }
            }, (error) => {
                refs.loadingState.classList.add('hidden');
                if (error.code === 'permission-denied') manejarErrorDePermisos(error);
                else { console.error("Error al escuchar cambios:", error); showModal('Error de Conexión', 'No se pudo cargar el inventario.'); }
            });
        }

        function renderizarListaInsumos(insumos) {
            const searchTerm = refs.searchInput.value.toLowerCase();
            const filteredInsumos = insumos.filter(item => item.nombre.toLowerCase().includes(searchTerm) || (item.codigo && item.codigo.toLowerCase().includes(searchTerm))).sort((a, b) => a.nombre.localeCompare(b.nombre));
            if (filteredInsumos.length === 0 && insumos.length > 0) {
                 refs.listaInsumos.innerHTML = `<p class="text-center text-gray-500 py-4">No se encontraron insumos para "${refs.searchInput.value}".</p>`;
            } else if (insumos.length === 0) {
                refs.emptyState.classList.remove('hidden');
                refs.listaInsumos.classList.add('hidden');
            } else {
                refs.emptyState.classList.add('hidden');
                refs.listaInsumos.classList.remove('hidden');
                refs.listaInsumos.innerHTML = filteredInsumos.map(insumo => {
                    const stockColorClass = insumo.cantidad <= 0 ? 'text-red-600' : (insumo.cantidad <= 10 ? 'text-yellow-600' : 'text-green-600');
                    return `<div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between gap-4"><div class="flex-grow"><p class="font-semibold text-lg">${insumo.nombre}</p><p class="text-sm text-gray-500 font-mono">Código: ${insumo.codigo || 'N/A'}</p></div><div class="flex items-center gap-3"><span data-id="${insumo.id}" data-action="edit-quantity" class="font-bold text-2xl ${stockColorClass} min-w-[100px] text-center p-2 rounded-md hover:bg-gray-100 cursor-pointer">${insumo.cantidad} ${insumo.unidad}</span><div class="flex flex-col sm:flex-row gap-2"><button data-id="${insumo.id}" data-action="restar" class="bg-red-100 text-red-700 h-10 w-10 rounded-full flex items-center justify-center font-bold text-2xl hover:bg-red-200">-</button><button data-id="${insumo.id}" data-action="sumar" class="bg-green-100 text-green-700 h-10 w-10 rounded-full flex items-center justify-center font-bold text-xl hover:bg-green-200">+</button></div></div><div class="flex gap-2"><button data-id="${insumo.id}" data-action="editar" class="text-gray-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg></button><button data-id="${insumo.id}" data-action="eliminar" class="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div>`;
                }).join('');
            }
        }
        
        async function mostrarModalEdicion(insumo) {
            const formHTML = `<div class="space-y-4"><div><label for="edit-nombre" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="edit-nombre" value="${insumo.nombre}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="edit-codigo" class="block text-sm font-medium text-gray-700">Código</label><input type="text" id="edit-codigo" value="${insumo.codigo || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="edit-unidad" class="block text-sm font-medium text-gray-700">Unidad</label><input type="text" id="edit-unidad" value="${insumo.unidad}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div></div>`;
            await showModal('Editar Insumo', formHTML, 'edit');
            refs.modal.saveBtn.onclick = async () => {
                const nuevoNombre = document.getElementById('edit-nombre').value.trim();
                const nuevoCodigo = document.getElementById('edit-codigo').value.trim();
                const nuevaUnidad = document.getElementById('edit-unidad').value.trim();
                if (!nuevoNombre || !nuevaUnidad) return alert('Nombre y unidad son obligatorios.');
                try {
                    await updateDoc(doc(db, "insumos", userId, "items", insumo.id), { nombre: nuevoNombre, codigo: nuevoCodigo, unidad: nuevaUnidad });
                    hideModal();
                } catch (error) {
                     if (error.code === 'permission-denied') manejarErrorDePermisos(error);
                     else { console.error("Error al guardar:", error); alert("No se pudieron guardar los cambios."); }
                }
            };
        }

        function descargarExcel() {
            if (inventarioActual.length === 0) return showModal('Inventario Vacío', 'No hay datos para exportar.');
            const headers = "Nombre\tCódigo\tCantidad\tUnidad\n";
            const rows = inventarioActual.map(item => `${item.nombre}\t${item.codigo || ''}\t${item.cantidad}\t${item.unidad}`).join("\n");
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([headers + rows], { type: 'application/vnd.ms-excel' }));
            link.download = 'inventario.xls';
            link.click();
        }
        
        async function cargarDatosIniciales() {
            if (!userId) return showModal('Error', 'Espera a que se asigne un ID de sesión.');
            const insumosIniciales = [{ nombre: "Phytogard Potasio", cantidad: 120, unidad: "Lt" }, { nombre: "Phytogard Magnesio", cantidad: 60, unidad: "Lt" },{ nombre: "CaB", cantidad: 100, unidad: "Lt" }, { nombre: "Aliette", cantidad: 349, unidad: "kg" },{ nombre: "Mulan", cantidad: 28.5, unidad: "Lt" }, { nombre: "Dicamba", cantidad: 4, unidad: "Lt" },{ nombre: "Cytoplant", cantidad: 55, unidad: "Lt" }, { nombre: "Koltar", cantidad: 20, unidad: "Lt" },{ nombre: "Bioamino-L", cantidad: 40, unidad: "Lt" }, { nombre: "Sulfacid", cantidad: 20, unidad: "Lt" },{ nombre: "Natur'l Oleo", cantidad: 380, unidad: "Lt" }, { nombre: "Stoller Zn", cantidad: 180, unidad: "Lt" },{ nombre: "Stoller Mg", cantidad: 160, unidad: "Lt" }, { nombre: "Glufosinato", cantidad: 32, unidad: "Lt" },{ nombre: "Glifosato", cantidad: 40, unidad: "Lt" }, { nombre: "2.4 D", cantidad: 2, unidad: "Lt" },{ nombre: "2.4 DB", cantidad: 8.5, unidad: "Lt" }, { nombre: "Clorpirifos", cantidad: 40, unidad: "Lt" },{ nombre: "Zintrac", cantidad: 50, unidad: "Lt" }, { nombre: "Oxicloruro de cobre", cantidad: 50, unidad: "kg" },{ nombre: "Nordox", cantidad: 200, unidad: "kg" }, { nombre: "Basfoliar Kelp", cantidad: 32, unidad: "Lt" },{ nombre: "Cormoran", cantidad: 17.5, unidad: "Lt" }, { nombre: "Imidan 70", cantidad: 8, unidad: "kg" },{ nombre: "Intrepid", cantidad: 3, unidad: "Lt" }, { nombre: "Shark", cantidad: 6.2, unidad: "Lt" },{ nombre: "Alion", cantidad: 8, unidad: "Lt" }, { nombre: "Closer", cantidad: 10, unidad: "Lt" },{ nombre: "Komet", cantidad: 3, unidad: "Lt" }, { nombre: "Amistar Top", cantidad: 19, unidad: "Lt" },{ nombre: "Ridomil", cantidad: 32, unidad: "kg" }, { nombre: "Blaukorn 12-10-20+2+", cantidad: 50, unidad: "Kg" },{ nombre: "Basfoliar 25-10-17", cantidad: 50, unidad: "Kg" }, { nombre: "Hidroxido de Cobre", cantidad: 12, unidad: "kg" },{ nombre: "Verno", cantidad: 10, unidad: "Kg" }, { nombre: "Atrazina", cantidad: 3, unidad: "kg" }];
            try {
                const batch = writeBatch(db);
                insumosIniciales.forEach(insumo => batch.set(doc(collection(db, "insumos", userId, "items")), { ...insumo, codigo: '', createdAt: new Date() }));
                await batch.commit();
                showModal('Éxito', 'La lista de insumos iniciales se ha cargado.');
            } catch (error) {
                if (error.code === 'permission-denied') manejarErrorDePermisos(error);
                else { console.error("Error al cargar datos:", error); showModal('Error', 'No se pudieron cargar los datos iniciales.'); }
            }
        }

        async function handleCsvImport() {
            if (!refs.csvFileInput.files.length) return showModal('Error', 'Por favor, selecciona un archivo CSV primero.');
            const file = refs.csvFileInput.files[0];
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    let nuevos = 0, actualizados = 0;
                    const batch = writeBatch(db);

                    for (const row of results.data) {
                        const nombre = (row.Producto || '').trim();
                        const codigo = (row.Código || row.Codigo || '').trim();
                        const cantidad = parseFloat(row.Cantidad);
                        const unidad = (row.Unidad || '').trim();

                        if (!nombre || !unidad || isNaN(cantidad)) continue;

                        const itemExistente = inventarioActual.find(item => 
                            (codigo && item.codigo && item.codigo.toLowerCase() === codigo.toLowerCase()) || 
                            (!codigo && item.nombre.toLowerCase() === nombre.toLowerCase())
                        );

                        if (itemExistente) {
                            const docRef = doc(db, "insumos", userId, "items", itemExistente.id);
                            batch.update(docRef, { cantidad });
                            actualizados++;
                        } else {
                            const docRef = doc(collection(db, "insumos", userId, "items"));
                            batch.set(docRef, { nombre, codigo, cantidad, unidad, createdAt: new Date() });
                            nuevos++;
                        }
                    }
                    
                    if (nuevos === 0 && actualizados === 0) return showModal('Aviso', 'No se encontraron datos válidos para importar. Revisa las columnas: Código, Producto, Cantidad, Unidad.');

                    try {
                        await batch.commit();
                        showModal('Importación Completa', `${actualizados} insumos actualizados y ${nuevos} insumos agregados.`);
                        activarTab('control-stock');
                    } catch (error) {
                        if (error.code === 'permission-denied') manejarErrorDePermisos(error);
                        else { console.error("Error al importar:", error); showModal('Error', 'No se pudo importar el archivo.'); }
                    }
                },
                error: (error) => showModal('Error', 'Hubo un problema al leer el archivo CSV.')
            });
        }

        async function analizarInventarioConGemini() {
            if (inventarioActual.length === 0) return showModal('Inventario Vacío', 'No hay insumos para analizar.');
            const loadingHtml = `<div class="flex flex-col items-center justify-center"><svg class="animate-spin h-8 w-8 text-purple-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-gray-600">La IA está analizando tu inventario...</p></div>`;
            showModal('✨ Análisis Inteligente', loadingHtml, 'alert');
            
            const listaFormateada = inventarioActual.map(item => `- Código: ${item.codigo || 'N/A'}, Nombre: ${item.nombre}, Cantidad: ${item.cantidad} ${item.unidad}`).join('\n');
            const prompt = `Eres un asistente de gestión de inventario para un taller o galpón. Analiza la siguiente lista de insumos, sus códigos, cantidades y unidades. Proporciona un resumen del estado del inventario, identifica los artículos con stock bajo (10 unidades o menos) y sugiere cuándo reponerlos. Además, ofrece ideas creativas de proyectos que se podrían realizar combinando algunos de estos materiales. Formatea tu respuesta de manera clara y útil usando títulos en negrita y viñetas. La lista de inventario es:\n\n${listaFormateada}\n\nPor favor, responde en español.`;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Error de la API: ${response.statusText}`);

                const result = await response.json();
                let text = 'No se pudo obtener una respuesta de la IA.';
                if (result.candidates?.[0]?.content?.parts?.[0]) text = result.candidates[0].content.parts[0].text;
                
                let htmlResponse = text.trim().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').split('\n').map(l => l.trim()).filter(l => l.length > 0).map(l => {
                    if (l.startsWith('* ') || l.startsWith('- ')) return `<li>${l.substring(2)}</li>`;
                    if (!l.includes('<strong>') && !l.includes('<li>')) return `<p>${l}</p>`;
                    return l;
                }).join('').replace(/<li>/g, '<ul><li>').replace(/<\/li>(?!<li>)/g, '</li></ul>').replace(/<p><ul>/g, '<ul>').replace(/<\/ul><\/p>/g, '</ul>').replace(/<p><strong>/g, '<strong>').replace(/<\/strong><\/p>/g, '</strong>');

                refs.modal.title.textContent = '✨ Análisis del Inventario';
                refs.modal.body.innerHTML = `<div class="prose max-w-none text-left">${htmlResponse}</div>`;
            } catch (error) {
                console.error("Error llamando a la API de Gemini:", error);
                refs.modal.title.textContent = 'Error en el Análisis';
                refs.modal.body.innerHTML = 'Hubo un problema al comunicarse con el servicio de IA.';
            }
        }

        main();
    </script>
</body>
</html>
