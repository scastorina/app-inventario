<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Insumos de Galpón con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .prose { max-width: 100%; }
        .prose strong { font-weight: 600; color: #111827; }
        .prose p { margin-bottom: 1rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 1rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.5rem; }
        .code-block {
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Control de Insumos de Galpón</h1>
            <p class="text-gray-600 mt-2">Gestiona tu stock con la ayuda de la Inteligencia Artificial.</p>
        </header>

        <!-- Sección para agregar nuevos insumos -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4">Agregar Nuevo Insumo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="nombre-insumo" placeholder="Nombre del insumo" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="codigo-insumo" placeholder="Código (Opcional)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="cantidad-inicial" placeholder="Cantidad" min="0" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="unidad-insumo" placeholder="Unidad (ej: Lt, Kg)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="agregar-btn" class="md:col-span-2 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Agregar al Inventario
                </button>
            </div>
        </div>

        <!-- Dashboard de inventario -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Dashboard de Inventario</h2>
                <button id="analizar-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-300 flex items-center gap-2">
                    ✨ Analizar Inventario con IA
                </button>
            </div>
            <div id="loading-state" class="text-center py-8">
                <p class="text-gray-500">Cargando inventario...</p>
            </div>
            <div id="container-principal">
                <!-- Este contenedor mostrará el estado de vacío o la lista de insumos -->
                <div id="empty-state" class="hidden text-center bg-white p-8 rounded-lg shadow-md">
                     <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">Inventario vacío</h3>
                    <p class="mt-1 text-sm text-gray-500">Aún no has agregado ningún insumo. ¡Empieza usando el formulario de arriba!</p>
                    <div class="mt-6">
                        <button id="cargar-datos-btn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-300">
                            Cargar Lista de Insumos Inicial
                        </button>
                    </div>
                </div>
                <div id="lista-insumos" class="space-y-3">
                    <!-- Los insumos se cargarán aquí dinámicamente -->
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>ID de Sesión: <span id="user-id-display" class="font-mono bg-gray-200 p-1 rounded"></span></p>
        </footer>
    </div>

    <!-- Modal Genérico -->
    <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop"></div>
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full z-10 modal-content transform scale-95">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="modal-body" class="text-gray-700"></div>
            <div id="modal-actions" class="mt-6 flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="modal-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Confirmar</button>
                <button id="modal-ok-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        // FIX: Se insertó la configuración de Firebase proporcionada por el usuario.
        const firebaseConfig = {
            apiKey: "AIzaSyAsjMYndgto8apKjasCtD7Hsblw5f6DV8c",
            authDomain: "stock-pomco.firebaseapp.com",
            projectId: "stock-pomco",
            storageBucket: "stock-pomco.firebasestorage.app",
            messagingSenderId: "414907870481",
            appId: "1:414907870481:web:04d62d1dc974cc466cb0b0",
            measurementId: "G-G7QXY50X7B"
        };

        // --- Declaración de Variables ---
        let app, db, auth, userId;
        let inventarioActual = [];

        // --- Referencias a Elementos del DOM ---
        const nombreInsumoInput = document.getElementById('nombre-insumo');
        const codigoInsumoInput = document.getElementById('codigo-insumo');
        const cantidadInicialInput = document.getElementById('cantidad-inicial');
        const unidadInsumoInput = document.getElementById('unidad-insumo');
        const agregarBtn = document.getElementById('agregar-btn');
        const containerPrincipal = document.getElementById('container-principal');
        const listaInsumosContainer = document.getElementById('lista-insumos');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const cargarDatosBtn = document.getElementById('cargar-datos-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const analizarBtn = document.getElementById('analizar-btn');
        const modal = document.getElementById('modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        let modalResolve;

        // --- Función Principal de Inicialización ---
        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        configurarEventListeners();
                        escucharCambiosEnInsumos();
                    } else {
                        // Si no hay usuario, iniciar sesión anónimamente
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                loadingState.classList.add('hidden');
                containerPrincipal.innerHTML = `<p class="text-red-500 text-center">Error al conectar con la base de datos. Revisa la consola.</p>`;
            }
        }

        // --- Lógica del Modal ---
        function showModal(title, body, type = 'alert') {
            modalTitle.textContent = title;
            modalBody.innerHTML = body;
            modalOkBtn.classList.toggle('hidden', type !== 'alert');
            modalCancelBtn.classList.toggle('hidden', type !== 'confirm');
            modalConfirmBtn.classList.toggle('hidden', type !== 'confirm');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            return new Promise(resolve => {
                modalResolve = resolve;
            });
        }

        function hideModal(value) {
            modalBackdrop.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (modalResolve) modalResolve(value);
            }, 300);
        }

        function manejarErrorDePermisos(error) {
            console.error("Error de permisos en Firestore:", error);
            const titulo = "Error de Permisos en la Base de Datos";
            const cuerpo = `
                <p class="mb-3">La aplicación no tiene permiso para leer o escribir en la base de datos. Esto generalmente se debe a que las <strong>Reglas de Seguridad</strong> de tu proyecto en Firebase no están configuradas correctamente.</p>
                <p class="mb-2">Por favor, ve a la sección <strong>Firestore Database > Reglas</strong> en tu Consola de Firebase y reemplaza las reglas existentes con las siguientes:</p>
                <div class="code-block">
                    rules_version = '2';<br>
                    service cloud.firestore {<br>
                    &nbsp;&nbsp;match /databases/{database}/documents {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;match /insumos/{userId}/{document=**} {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if request.auth != null && request.auth.uid == userId;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;}<br>
                    }
                </div>
            `;
            showModal(titulo, cuerpo);
        }
        
        // --- Lógica de la Aplicación ---
        function configurarEventListeners() {
            agregarBtn.addEventListener('click', agregarInsumo);
            analizarBtn.addEventListener('click', analizarInventarioConGemini);
            cargarDatosBtn.addEventListener('click', cargarDatosIniciales);

            listaInsumosContainer.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target || !userId) return;

                const insumoId = target.dataset.id;
                if (!insumoId) return;

                const docRef = doc(db, "insumos", userId, "items", insumoId);

                try {
                    if (target.dataset.action === 'restar') {
                        await updateDoc(docRef, { cantidad: increment(-1) });
                    } else if (target.dataset.action === 'sumar') {
                        await updateDoc(docRef, { cantidad: increment(1) });
                    } else if (target.dataset.action === 'eliminar') {
                        const confirmed = await showModal('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar este insumo del inventario?', 'confirm');
                        if (confirmed) {
                           await deleteDoc(docRef);
                        }
                    }
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        manejarErrorDePermisos(error);
                    } else {
                        console.error("Error al actualizar el insumo:", error);
                        showModal("Error", "No se pudo actualizar el insumo. Inténtalo de nuevo.");
                    }
                }
            });

            modalBackdrop.addEventListener('click', () => hideModal(false));
            modalCancelBtn.addEventListener('click', () => hideModal(false));
            modalConfirmBtn.addEventListener('click', () => hideModal(true));
            modalOkBtn.addEventListener('click', () => hideModal(true));
        }

        async function agregarInsumo() {
            if (!userId) {
                showModal('Error', 'No se ha podido identificar al usuario. Por favor, recarga la página.');
                return;
            }
            const nombre = nombreInsumoInput.value.trim();
            const codigo = codigoInsumoInput.value.trim();
            const cantidad = parseFloat(cantidadInicialInput.value);
            const unidad = unidadInsumoInput.value.trim();

            if (!nombre || !unidad) {
                showModal('Campos Vacíos', 'Por favor, ingresa un nombre y una unidad para el insumo.');
                return;
            }
            if (isNaN(cantidad) || cantidad < 0) {
                showModal('Cantidad Inválida', 'Por favor, ingresa una cantidad inicial válida (0 o más).');
                return;
            }

            try {
                const insumosCollection = collection(db, "insumos", userId, "items");
                await addDoc(insumosCollection, { 
                    nombre, 
                    codigo: codigo || '',
                    cantidad, 
                    unidad,
                    createdAt: new Date() 
                });
                nombreInsumoInput.value = '';
                codigoInsumoInput.value = '';
                cantidadInicialInput.value = '';
                unidadInsumoInput.value = '';
                nombreInsumoInput.focus();
            } catch (error) {
                if (error.code === 'permission-denied') {
                    manejarErrorDePermisos(error);
                } else {
                    console.error("Error al agregar el insumo: ", error);
                    showModal('Error', 'Hubo un error al guardar el insumo. Revisa la consola para más detalles.');
                }
            }
        }

        function escucharCambiosEnInsumos() {
            if (!userId) return;
            const insumosCollection = collection(db, "insumos", userId, "items");
            const q = query(insumosCollection);

            onSnapshot(q, (snapshot) => {
                loadingState.classList.add('hidden');
                containerPrincipal.classList.remove('hidden');
                if (snapshot.empty) {
                    emptyState.classList.remove('hidden');
                    listaInsumosContainer.innerHTML = '';
                    listaInsumosContainer.classList.add('hidden');
                    inventarioActual = [];
                } else {
                    emptyState.classList.add('hidden');
                    listaInsumosContainer.classList.remove('hidden');
                    const insumos = [];
                    snapshot.forEach(doc => insumos.push({ id: doc.id, ...doc.data() }));
                    insumos.sort((a, b) => a.nombre.localeCompare(b.nombre));
                    inventarioActual = insumos;
                    renderizarListaInsumos(insumos);
                }
            }, (error) => {
                loadingState.classList.add('hidden');
                if (error.code === 'permission-denied') {
                    manejarErrorDePermisos(error);
                } else {
                    console.error("Error al escuchar cambios en Firestore: ", error);
                    showModal('Error de Conexión', 'No se pudo cargar el inventario desde la base de datos.');
                }
            });
        }

        function renderizarListaInsumos(insumos) {
            listaInsumosContainer.innerHTML = insumos.map(insumo => {
                let stockColorClass = 'text-green-600';
                if (insumo.cantidad <= 10 && insumo.cantidad > 0) stockColorClass = 'text-yellow-600';
                else if (insumo.cantidad <= 0) stockColorClass = 'text-red-600';

                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between gap-4 transition-shadow duration-200 hover:shadow-md" id="item-${insumo.id}">
                        <div class="flex-grow">
                            <p class="font-semibold text-lg">${insumo.nombre}</p>
                            <p class="text-sm text-gray-500 font-mono">Código: ${insumo.codigo || 'N/A'}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-2xl ${stockColorClass} min-w-[80px] text-center">${insumo.cantidad} ${insumo.unidad}</span>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button data-id="${insumo.id}" data-action="restar" class="bg-red-100 text-red-700 h-10 w-10 rounded-full flex items-center justify-center font-bold text-2xl hover:bg-red-200 transition-colors" aria-label="Restar uno">-</button>
                                <button data-id="${insumo.id}" data-action="sumar" class="bg-green-100 text-green-700 h-10 w-10 rounded-full flex items-center justify-center font-bold text-xl hover:bg-green-200 transition-colors" aria-label="Sumar uno">+</button>
                            </div>
                        </div>
                        <button data-id="${insumo.id}" data-action="eliminar" class="text-gray-400 hover:text-red-500 transition-colors" aria-label="Eliminar insumo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        async function cargarDatosIniciales() {
            if (!userId) {
                showModal('Error', 'Espera a que se asigne un ID de sesión para cargar los datos.');
                return;
            }

            const insumosIniciales = [
                { nombre: "Phytogard Potasio", cantidad: 120, unidad: "Lt" }, { nombre: "Phytogard Magnesio", cantidad: 60, unidad: "Lt" },
                { nombre: "CaB", cantidad: 100, unidad: "Lt" }, { nombre: "Aliette", cantidad: 349, unidad: "kg" },
                { nombre: "Mulan", cantidad: 28.5, unidad: "Lt" }, { nombre: "Dicamba", cantidad: 4, unidad: "Lt" },
                { nombre: "Cytoplant", cantidad: 55, unidad: "Lt" }, { nombre: "Koltar", cantidad: 20, unidad: "Lt" },
                { nombre: "Bioamino-L", cantidad: 40, unidad: "Lt" }, { nombre: "Sulfacid", cantidad: 20, unidad: "Lt" },
                { nombre: "Natur'l Oleo", cantidad: 380, unidad: "Lt" }, { nombre: "Stoller Zn", cantidad: 180, unidad: "Lt" },
                { nombre: "Stoller Mg", cantidad: 160, unidad: "Lt" }, { nombre: "Glufosinato", cantidad: 32, unidad: "Lt" },
                { nombre: "Glifosato", cantidad: 40, unidad: "Lt" }, { nombre: "2.4 D", cantidad: 2, unidad: "Lt" },
                { nombre: "2.4 DB", cantidad: 8.5, unidad: "Lt" }, { nombre: "Clorpirifos", cantidad: 40, unidad: "Lt" },
                { nombre: "Zintrac", cantidad: 50, unidad: "Lt" }, { nombre: "Oxicloruro de cobre", cantidad: 50, unidad: "kg" },
                { nombre: "Nordox", cantidad: 200, unidad: "kg" }, { nombre: "Basfoliar Kelp", cantidad: 32, unidad: "Lt" },
                { nombre: "Cormoran", cantidad: 17.5, unidad: "Lt" }, { nombre: "Imidan 70", cantidad: 8, unidad: "kg" },
                { nombre: "Intrepid", cantidad: 3, unidad: "Lt" }, { nombre: "Shark", cantidad: 6.2, unidad: "Lt" },
                { nombre: "Alion", cantidad: 8, unidad: "Lt" }, { nombre: "Closer", cantidad: 10, unidad: "Lt" },
                { nombre: "Komet", cantidad: 3, unidad: "Lt" }, { nombre: "Amistar Top", cantidad: 19, unidad: "Lt" },
                { nombre: "Ridomil", cantidad: 32, unidad: "kg" }, { nombre: "Blaukorn 12-10-20+2+", cantidad: 50, unidad: "Kg" },
                { nombre: "Basfoliar 25-10-17", cantidad: 50, unidad: "Kg" }, { nombre: "Hidroxido de Cobre", cantidad: 12, unidad: "kg" },
                { nombre: "Verno", cantidad: 10, unidad: "Kg" }, { nombre: "Atrazina", cantidad: 3, unidad: "kg" }
            ];

            try {
                const batch = writeBatch(db);
                const insumosCollection = collection(db, "insumos", userId, "items");
                
                insumosIniciales.forEach(insumo => {
                    const docRef = doc(insumosCollection);
                    batch.set(docRef, { ...insumo, codigo: '', createdAt: new Date() });
                });

                await batch.commit();
                showModal('Éxito', 'La lista de insumos iniciales se ha cargado correctamente.');

            } catch (error) {
                if (error.code === 'permission-denied') {
                    manejarErrorDePermisos(error);
                } else {
                    console.error("Error al cargar datos iniciales:", error);
                    showModal('Error', 'No se pudieron cargar los datos iniciales.');
                }
            }
        }

        async function analizarInventarioConGemini() {
            if (inventarioActual.length === 0) {
                showModal('Inventario Vacío', 'No hay insumos para analizar. Agrega algunos primero.');
                return;
            }

            const loadingHtml = `
                <div class="flex flex-col items-center justify-center">
                    <svg class="animate-spin h-8 w-8 text-purple-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-600">La IA está analizando tu inventario... Por favor, espera.</p>
                </div>`;
            showModal('✨ Análisis Inteligente', loadingHtml, 'alert');
            
            const listaFormateada = inventarioActual.map(item => `- Código: ${item.codigo || 'N/A'}, Nombre: ${item.nombre}, Cantidad: ${item.cantidad} ${item.unidad}`).join('\n');
            const prompt = `Eres un asistente de gestión de inventario para un taller o galpón. Analiza la siguiente lista de insumos, sus códigos, cantidades y unidades. Proporciona un resumen del estado del inventario, identifica los artículos con stock bajo (10 unidades o menos) y sugiere cuándo reponerlos. Además, ofrece ideas creativas de proyectos que se podrían realizar combinando algunos de estos materiales. Formatea tu respuesta de manera clara y útil usando títulos en negrita y viñetas. La lista de inventario es:\n\n${listaFormateada}\n\nPor favor, responde en español.`;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error de la API: ${response.statusText}`);
                }

                const result = await response.json();
                
                let text = 'No se pudo obtener una respuesta de la IA.';
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    text = result.candidates[0].content.parts[0].text;
                }
                
                let htmlResponse = text
                    .trim()
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                        if (line.startsWith('* ') || line.startsWith('- ')) {
                            return `<li>${line.substring(2)}</li>`;
                        }
                        if (!line.includes('<strong>') && !line.includes('<li>')) {
                             return `<p>${line}</p>`;
                        }
                        return line;
                    })
                    .join('');

                htmlResponse = htmlResponse.replace(/<li>/g, '<ul><li>').replace(/<\/li>(?!<li>)/g, '</li></ul>');
                htmlResponse = htmlResponse.replace(/<p><ul>/g, '<ul>').replace(/<\/ul><\/p>/g, '</ul>');
                htmlResponse = htmlResponse.replace(/<p><strong>/g, '<strong>').replace(/<\/strong><\/p>/g, '</strong>');

                modalTitle.textContent = '✨ Análisis del Inventario';
                modalBody.innerHTML = `<div class="prose max-w-none text-left">${htmlResponse}</div>`;

            } catch (error) {
                console.error("Error llamando a la API de Gemini:", error);
                modalTitle.textContent = 'Error en el Análisis';
                modalBody.innerHTML = 'Hubo un problema al comunicarse con el servicio de IA. Por favor, revisa la consola e inténtalo de nuevo más tarde.';
            }
        }

        // Iniciar la aplicación
        main();
    </script>
</body>
</html>
