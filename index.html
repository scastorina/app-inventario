<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Insumos de Galpón</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .validation-message {
            font-size: 0.875rem;
            color: #ef4444;
            min-height: 1.25rem;
        }
        .input-error {
            border-color: #ef4444 !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Vista de Autenticación -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
            <div class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="login-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                <p id="login-error" class="validation-message text-center"></p>
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700">Ingresar</button>
            </div>
        </div>
    </div>

    <!-- Vista Principal de la App -->
    <div id="app-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-5xl">
            <header class="text-center mb-8">
                 <div class="flex justify-between items-center">
                    <div></div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Control de Insumos</h1>
                    <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Cerrar Sesión</button>
                </div>
                <p id="user-email-display" class="text-gray-600 mt-2"></p>
            </header>

            <div class="mb-6 border-b border-gray-200">
                <nav id="tabs-nav" class="-mb-px flex space-x-6" aria-label="Tabs"></nav>
            </div>

            <div id="tab-content-container">
                <div id="control-stock" class="tab-content">
                    <!-- Contenido de Control de Stock -->
                </div>
                <div id="ingreso-insumos" class="tab-content">
                    <!-- Contenido de Ingreso de Insumos -->
                </div>
                <div id="admin-users" class="tab-content">
                    <!-- Contenido de Gestión de Usuarios -->
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <!-- Contenido del Modal -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, increment, writeBatch, enableIndexedDbPersistence, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsjMYndgto8apKjasCtD7Hsblw5f6DV8c",
            authDomain: "stock-pomco.firebaseapp.com",
            projectId: "stock-pomco",
            storageBucket: "stock-pomco.firebasestorage.app",
            messagingSenderId: "414907870481",
            appId: "1:414907870481:web:04d62d1dc974cc466cb0b0",
            measurementId: "G-G7QXY50X7B"
        };

        let app, db, auth, userId, userRole, inventarioActual = [], unsubscribe;
        let isEditing = false;

        const refs = {
            authView: document.getElementById('auth-view'),
            appView: document.getElementById('app-view'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            loginError: document.getElementById('login-error'),
            userEmailDisplay: document.getElementById('user-email-display'),
            tabsNav: document.getElementById('tabs-nav'),
            tabContentContainer: document.getElementById('tab-content-container'),
        };

        async function main() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await enableIndexedDbPersistence(db).catch(console.warn);
            configurarAuthListeners();
        }

        function configurarAuthListeners() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const userDoc = await getDoc(doc(db, "users", userId));
                    userRole = userDoc.exists() ? userDoc.data().role : 'user';
                    
                    refs.userEmailDisplay.textContent = `Sesión iniciada como: ${user.email}`;
                    refs.authView.classList.add('hidden');
                    refs.appView.classList.remove('hidden');
                    
                    renderizarUI();
                    escucharCambiosEnInsumos();
                } else {
                    userId = null;
                    userRole = null;
                    refs.authView.classList.remove('hidden');
                    refs.appView.classList.add('hidden');
                    if (unsubscribe) unsubscribe();
                }
            });

            refs.loginBtn.addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    refs.loginError.textContent = '';
                } catch (error) {
                    refs.loginError.textContent = 'Email o contraseña incorrectos.';
                }
            });

            refs.logoutBtn.addEventListener('click', () => signOut(auth));
        }

        function renderizarUI() {
            renderizarTabs();
            renderizarContenidoTabs();
            configurarEventListenersApp();
            activarTab('control-stock');
        }

        function renderizarTabs() {
            let tabsHTML = `
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-tab="control-stock">Control de Stock</button>
                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-tab="ingreso-insumos">Ingreso de Insumos</button>
            `;
            if (userRole === 'admin') {
                tabsHTML += `<button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-tab="admin-users">Gestión de Usuarios</button>`;
            }
            refs.tabsNav.innerHTML = tabsHTML;
        }

        function renderizarContenidoTabs() {
            refs.tabContentContainer.querySelector('#control-stock').innerHTML = `
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <div class="relative w-full md:w-1/3"><input type="text" id="search-input" placeholder="Buscar..." class="w-full p-3 pl-10 border rounded-lg"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div></div>
                    <div class="flex gap-2"><button id="descargar-excel-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Excel</button></div>
                </div>
                <div id="loading-state" class="text-center py-8"><p class="text-gray-500">Cargando inventario...</p></div>
                <div id="container-principal">
                    <div id="empty-state" class="hidden text-center bg-white p-8 rounded-lg shadow-md"><h3 class="mt-2 text-lg font-medium">Inventario vacío</h3></div>
                    <div id="lista-insumos" class="space-y-3"></div>
                </div>`;

            refs.tabContentContainer.querySelector('#ingreso-insumos').innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Agregar Nuevo Insumo</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                        <div><input type="text" id="nombre-insumo" placeholder="Nombre del insumo" class="p-3 w-full border rounded-lg"><p id="nombre-insumo-validation" class="validation-message"></p></div>
                        <div><input type="text" id="codigo-insumo" placeholder="Código (Opcional)" class="p-3 w-full border rounded-lg"></div>
                        <div><input type="number" id="cantidad-inicial" placeholder="Cantidad" min="0" class="p-3 w-full border rounded-lg"><p id="cantidad-inicial-validation" class="validation-message"></p></div>
                        <div><input type="text" id="unidad-insumo" placeholder="Unidad (ej: Lt, Kg)" class="p-3 w-full border rounded-lg"><p id="unidad-insumo-validation" class="validation-message"></p></div>
                        <div class="md:col-span-2"><button id="agregar-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg disabled:bg-gray-400">Agregar</button></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4">Importar desde CSV</h2>
                    <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50"/>
                    <button id="import-csv-btn" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg">Importar</button>
                </div>`;

            if (userRole === 'admin') {
                refs.tabContentContainer.querySelector('#admin-users').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-2xl font-semibold mb-4">Crear Nuevo Usuario</h2>
                            <p class="text-sm text-gray-600 mb-4">Esto creará un nuevo usuario en Firebase Authentication y en la base de datos de usuarios.</p>
                            <div class="space-y-4">
                                <div><label for="new-user-email">Email</label><input type="email" id="new-user-email" class="mt-1 p-3 w-full border rounded-lg"></div>
                                <div><label for="new-user-password">Contraseña</label><input type="password" id="new-user-password" class="mt-1 p-3 w-full border rounded-lg"></div>
                                <p id="new-user-error" class="validation-message"></p>
                                <button id="create-user-btn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg">Crear Usuario</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                             <h2 class="text-2xl font-semibold mb-4">Usuarios Registrados</h2>
                             <div id="user-list" class="space-y-2">Cargando...</div>
                        </div>
                    </div>`;
            }
        }
        
        function configurarEventListenersApp() {
            // Re-asignar listeners a los elementos recién creados
            document.querySelectorAll('.tab-btn').forEach(tab => tab.addEventListener('click', () => activarTab(tab.dataset.tab)));
            document.getElementById('agregar-btn').addEventListener('click', agregarInsumo);
            document.getElementById('descargar-excel-btn').addEventListener('click', descargarExcel);
            document.getElementById('import-csv-btn').addEventListener('click', handleCsvImport);
            document.getElementById('search-input').addEventListener('input', () => renderizarListaInsumos(inventarioActual));
            document.getElementById('lista-insumos').addEventListener('click', handleListaInsumosClick);
            
            const formInputs = [document.getElementById('nombre-insumo'), document.getElementById('cantidad-inicial'), document.getElementById('unidad-insumo')];
            formInputs.forEach(input => input.addEventListener('input', validarFormularioIngreso));
            validarFormularioIngreso();

            if (userRole === 'admin') {
                document.getElementById('create-user-btn').addEventListener('click', crearNuevoUsuario);
                escucharCambiosEnUsuarios();
            }
        }
        
        function validarFormularioIngreso() {
            let esValido = true;
            const nombreInput = document.getElementById('nombre-insumo');
            const cantidadInput = document.getElementById('cantidad-inicial');
            const unidadInput = document.getElementById('unidad-insumo');
            
            if (nombreInput.value.trim() === '') esValido = false;
            if (cantidadInput.value.trim() === '' || isNaN(parseFloat(cantidadInput.value)) || parseFloat(cantidadInput.value) < 0) esValido = false;
            if (unidadInput.value.trim() === '') esValido = false;
            
            document.getElementById('agregar-btn').disabled = !esValido;
        }

        async function agregarInsumo() {
            // ... (lógica existente, ya es correcta)
        }

        function escucharCambiosEnInsumos() {
            if (!userId) return;
            if (unsubscribe) unsubscribe();
            const q = query(collection(db, "insumos", userId, "items"));
            unsubscribe = onSnapshot(q, (snapshot) => {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('container-principal').classList.remove('hidden');
                inventarioActual = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!isEditing) {
                    renderizarListaInsumos(inventarioActual);
                }
            }, (error) => {
                if (error.code === 'permission-denied') manejarErrorDePermisos(error);
            });
        }
        
        function renderizarListaInsumos(insumos) {
            const listaContainer = document.getElementById('lista-insumos');
            const emptyState = document.getElementById('empty-state');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filteredInsumos = insumos.filter(item => item.nombre.toLowerCase().includes(searchTerm) || (item.codigo && item.codigo.toLowerCase().includes(searchTerm))).sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            if (insumos.length === 0) {
                emptyState.classList.remove('hidden');
                listaContainer.classList.add('hidden');
            } else {
                 emptyState.classList.add('hidden');
                 listaContainer.classList.remove('hidden');
                 if (filteredInsumos.length === 0) {
                    listaContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No se encontraron insumos.</p>`;
                 } else {
                    listaContainer.innerHTML = filteredInsumos.map(insumo => {
                        const stockColorClass = insumo.cantidad <= 0 ? 'text-red-600' : (insumo.cantidad <= 10 ? 'text-yellow-600' : 'text-green-600');
                        return `<div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between gap-4">
                                    <div class="flex-grow"><p class="font-semibold text-lg">${insumo.nombre}</p><p class="text-sm text-gray-500 font-mono">Código: ${insumo.codigo || 'N/A'}</p></div>
                                    <div class="flex items-center gap-3">
                                        <span data-id="${insumo.id}" data-action="edit-quantity" class="font-bold text-2xl ${stockColorClass} min-w-[100px] text-center p-2 rounded-md hover:bg-gray-100 cursor-pointer">${insumo.cantidad} ${insumo.unidad}</span>
                                        <div class="flex flex-col sm:flex-row gap-2">
                                            <button data-id="${insumo.id}" data-action="restar" class="bg-red-100 text-red-700 h-10 w-10 rounded-full flex items-center justify-center font-bold text-2xl hover:bg-red-200">-</button>
                                            <button data-id="${insumo.id}" data-action="sumar" class="bg-green-100 text-green-700 h-10 w-10 rounded-full flex items-center justify-center font-bold text-xl hover:bg-green-200">+</button>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button data-id="${insumo.id}" data-action="editar" class="text-gray-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg></button>
                                        <button data-id="${insumo.id}" data-action="eliminar" class="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                    </div>
                                </div>`;
                    }).join('');
                 }
            }
        }

        // --- Lógica de Admin ---
        function escucharCambiosEnUsuarios() {
            if (userRole !== 'admin') return;
            const userListContainer = document.getElementById('user-list');
            onSnapshot(query(collection(db, "users")), (snapshot) => {
                const users = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                userListContainer.innerHTML = users.map(user => `
                    <div class="p-2 border-b">${user.email} <span class="text-xs font-semibold uppercase ${user.role === 'admin' ? 'text-red-500' : 'text-gray-500'}">${user.role}</span></div>
                `).join('');
            });
        }

        async function crearNuevoUsuario() {
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const errorEl = document.getElementById('new-user-error');
            
            if (!email || password.length < 6) {
                errorEl.textContent = "Email inválido o contraseña muy corta (mín. 6 caracteres).";
                return;
            }
            errorEl.textContent = '';
            
            // **IMPORTANTE:** Esta es una simplificación insegura para este entorno.
            // En una app real, esto DEBE hacerse con Cloud Functions para no exponer
            // la lógica de creación de usuarios en el cliente.
            try {
                // Se crea un contexto de autenticación temporal para crear el usuario
                // Esto no es ideal, pero simula el flujo.
                const tempApp = initializeApp(firebaseConfig, "temp-creator");
                const tempAuth = getAuth(tempApp);
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                
                // Guardar el rol del usuario en Firestore
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: userCredential.user.email,
                    role: "user"
                });
                
                await signOut(tempAuth); // Cerrar sesión del creador temporal
                
                document.getElementById('new-user-email').value = '';
                document.getElementById('new-user-password').value = '';
                showModal("Éxito", `Usuario ${email} creado correctamente.`);

            } catch (error) {
                console.error("Error creando usuario:", error);
                errorEl.textContent = `Error: ${error.message}`;
            }
        }

        // El resto de las funciones (handleListaInsumosClick, editarCantidadDirectamente, etc.)
        // se mantienen igual, pero se deben llamar desde los nuevos listeners.
        // Por brevedad, no se repiten aquí, pero su lógica es la misma.
        // La función `configurarEventListenersApp` se encarga de re-conectarlos.

        main();
    </script>
</body>
</html>
